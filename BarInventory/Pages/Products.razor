@page "/products"
@using BarInventory.BarDB.Models

<PageTitle>Products - Bar Inventory</PageTitle>

<div class="page-header d-flex justify-between align-center" style="flex-wrap: wrap; gap: 1rem;">
    <div>
        <h1 class="page-title">Product Catalog</h1>
        <p class="page-subtitle">@(ProductList?.Count ?? 0) products</p>
    </div>
    <button class="btn btn-primary" @onclick="OpenAddProduct">
        ‚ûï Add Product
    </button>
</div>

@* Category Filter *@
<div class="category-pills mb-md">
    <button class='category-pill @(SelectedCategoryId == null ? "active" : "")' @onclick="() => FilterByCategory(null)">
        All (@(ProductList?.Count ?? 0))
    </button>
    @if (CategoryDropDowns != null)
    {
        @foreach (var category in CategoryDropDowns)
        {
            var count = ProductList?.Count(p => p.Category == category.Key) ?? 0;
            <button class='category-pill @(SelectedCategoryId == category.Key ? "active" : "")' 
                    @onclick="() => FilterByCategory(category.Key)">
                @GetCategoryIcon(category.Key) @category.Value (@count)
            </button>
        }
    }
</div>

@* Search *@
<div class="search-wrapper mb-md">
    <span class="search-icon">üîç</span>
    <input type="text" 
           class="form-control" 
           placeholder="Search products..." 
           @bind="SearchQuery" 
           @bind:event="oninput" />
</div>

@* Products Table *@
<div class="card">
    <div class="card-body" style="padding: 0;">
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 50px;"></th>
                        <th>Product</th>
                        <th>Category</th>
                        <th>Size</th>
                        <th class="number">Cost</th>
                        <th class="number">Price</th>
                        <th class="number">Servings</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var product in GetFilteredProducts())
                    {
                        <tr>
                            <td>
                                <button class="btn btn-ghost btn-sm" @onclick="() => EditProduct(product)">‚úèÔ∏è</button>
                            </td>
                            <td>
                                <div style="font-weight: 500;">@product.Brand @product.Name</div>
                                @if (!string.IsNullOrEmpty(product.Barcode))
                                {
                                    <div class="text-muted" style="font-size: 0.8rem;">@product.Barcode</div>
                                }
                            </td>
                            <td>
                                <span class="item-badge @GetCategoryBadgeClass(product.Category)">
                                    @GetCategoryName(product.Category)
                                </span>
                            </td>
                            <td>@product.SizeDescription</td>
                            <td class="number">@product.UnitCost.ToString("C2")</td>
                            <td class="number">@product.UnitPrice.ToString("C2")</td>
                            <td class="number">
                                @if (product.ServingsPerUnit.HasValue)
                                {
                                    @product.ServingsPerUnit.Value.ToString("0")
                                }
                                else
                                {
                                    <span class="text-muted">1</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@if (!GetFilteredProducts().Any())
{
    <div class="empty-state mt-lg">
        <div class="empty-state-icon">üì¶</div>
        <h2 class="empty-state-title">No Products Found</h2>
        <p class="empty-state-text">@(string.IsNullOrEmpty(FilterMessage) ? "Try adjusting your search or filters." : FilterMessage)</p>
    </div>
}

@* Add/Edit Product Modal *@
@if (ShowProductModal)
{
    <div class="modal-backdrop" @onclick="CloseModal">
        <div class="modal" @onclick:stopPropagation="true" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">@(IsNewProduct ? "Add Product" : "Edit Product")</h3>
                <button class="modal-close" @onclick="CloseModal">√ó</button>
            </div>
            <div class="modal-body">
                @if (!string.IsNullOrEmpty(FormErrorMessage))
                {
                    <div class="alert alert-danger mb-md">@FormErrorMessage</div>
                }
                
                <div class="d-flex gap-md" style="flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label class="form-label">Brand</label>
                        <input type="text" class="form-control" @bind="DataToUpsert!.Brand" placeholder="e.g., Tito's" />
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" @bind="DataToUpsert!.Name" placeholder="e.g., Vodka" />
                    </div>
                </div>
                
                <div class="d-flex gap-md" style="flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label class="form-label">Category</label>
                        <select class="form-control" @bind="DataToUpsert!.Category">
                            @if (CategoryDropDowns != null)
                            {
                                @foreach (var cat in CategoryDropDowns)
                                {
                                    <option value="@cat.Key">@cat.Value</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label class="form-label">Container Type</label>
                        <select class="form-control" @bind="DataToUpsert!.ContainerType">
                            @if (ContainerTypeDropDowns != null)
                            {
                                @foreach (var ct in ContainerTypeDropDowns)
                                {
                                    <option value="@ct.Key">@ct.Value</option>
                                }
                            }
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Size Description</label>
                    <input type="text" class="form-control" @bind="DataToUpsert!.SizeDescription" placeholder="e.g., 750ml, 12oz can" />
                </div>
                
                <div class="d-flex gap-md" style="flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 120px;">
                        <label class="form-label">Unit Cost</label>
                        <input type="number" class="form-control" @bind="DataToUpsert!.UnitCost" step="0.01" min="0" />
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 120px;">
                        <label class="form-label">Unit Price</label>
                        <input type="number" class="form-control" @bind="DataToUpsert!.UnitPrice" step="0.01" min="0" />
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 120px;">
                        <label class="form-label">Servings/Unit</label>
                        <input type="number" class="form-control" @bind="DataToUpsert!.ServingsPerUnit" step="1" min="1" placeholder="Optional" />
                    </div>
                </div>
                
                <div class="d-flex gap-md" style="flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Barcode (Optional)</label>
                        <input type="text" class="form-control" @bind="DataToUpsert!.Barcode" placeholder="UPC/EAN" />
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">SKU (Optional)</label>
                        <input type="text" class="form-control" @bind="DataToUpsert!.Sku" placeholder="Internal SKU" />
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" @bind="DataToUpsert!.IsActive" /> Active
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                @if (!IsNewProduct)
                {
                    <button class="btn btn-danger" style="margin-right: auto;" @onclick="() => ShowDeleteConfirm = true">üóëÔ∏è Delete</button>
                }
                <button class="btn btn-outline" @onclick="CloseModal">Cancel</button>
                <button class="btn btn-primary" @onclick="SaveProduct">
                    @(IsNewProduct ? "Add Product" : "Save Changes")
                </button>
            </div>
        </div>
    </div>
}

@* Delete Confirmation Modal *@
@if (ShowDeleteConfirm)
{
    <div class="modal-backdrop" @onclick="() => ShowDeleteConfirm = false">
        <div class="modal" @onclick:stopPropagation="true" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">‚ö†Ô∏è Confirm Delete</h3>
                <button class="modal-close" @onclick="() => ShowDeleteConfirm = false">√ó</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong>@DataToUpsert?.Brand @DataToUpsert?.Name</strong>?</p>
                <p class="text-muted" style="font-size: 0.875rem;">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" @onclick="() => ShowDeleteConfirm = false">Cancel</button>
                <button class="btn btn-danger" @onclick="DeleteProduct">üóëÔ∏è Delete</button>
            </div>
        </div>
    </div>
}

@code {
    [Inject]
    private BarInventory.BarDB.Service DbService { get; set; } = default!;

    [Inject]
    private NavigationManager NavigationManager { get; set; } = default!;

    // Data Lists
    protected List<ProductsQueryResult>? ProductList { get; set; } = null;

    // Dropdown Dictionaries - loaded from database
    protected Dictionary<int, string>? CategoryDropDowns = null;
    protected Dictionary<int, string>? ContainerTypeDropDowns = null;

    // Filter/Search State
    protected int? SelectedCategoryId = null;
    protected string SearchQuery = "";
    protected string FilterMessage = "";

    // Modal State
    protected bool ShowProductModal = false;
    protected bool IsNewProduct = true;
    protected string? FormErrorMessage = null;
    protected ProductsUpsertInput? DataToUpsert { get; set; }
    
    // Delete confirmation
    protected bool ShowDeleteConfirm = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            BuildDropDowns();
            LoadData();
            StateHasChanged();
        }
    }

    protected void BuildDropDowns()
    {
        // Load Product Categories
        if (CategoryDropDowns == null)
        {
            CategoryDropDowns = new Dictionary<int, string>();
            var output = DbService.ProductCategoriesQuery(new ProductCategoriesQueryInput());
            if (output.ReturnValue == ProductCategoriesQueryOutput.Returns.Ok && output.ResultData != null)
            {
                foreach (var item in output.ResultData.OrderBy(x => x.SortOrder))
                {
                    CategoryDropDowns.Add(item.Id, item.Name);
                }
            }
        }

        // Load Container Types
        if (ContainerTypeDropDowns == null)
        {
            ContainerTypeDropDowns = new Dictionary<int, string>();
            var output = DbService.ContainerTypesQuery(new ContainerTypesQueryInput());
            if (output.ReturnValue == ContainerTypesQueryOutput.Returns.Ok && output.ResultData != null)
            {
                foreach (var item in output.ResultData.OrderBy(x => x.SortOrder))
                {
                    ContainerTypeDropDowns.Add(item.Id, item.Name);
                }
            }
        }
    }

    protected void LoadData()
    {
        var queryInput = new ProductsQueryInput();
        var queryOutput = DbService.ProductsQuery(queryInput);

        if (queryOutput.ReturnValue == ProductsQueryOutput.Returns.Ok)
        {
            ProductList?.Clear();
            ProductList = queryOutput.ResultData;

            if (ProductList == null || ProductList.Count == 0)
            {
                FilterMessage = "No products found";
                ProductList = null;
            }
        }
        else
        {
            ProductList = null;
            FilterMessage = "No products found";
        }
    }

    protected List<ProductsQueryResult> GetFilteredProducts()
    {
        if (ProductList == null) return new List<ProductsQueryResult>();

        var filtered = ProductList.AsEnumerable();

        if (SelectedCategoryId.HasValue)
            filtered = filtered.Where(p => p.Category == SelectedCategoryId.Value);

        if (!string.IsNullOrWhiteSpace(SearchQuery))
        {
            var query = SearchQuery.ToLower();
            filtered = filtered.Where(p =>
                p.Name.ToLower().Contains(query) ||
                p.Brand.ToLower().Contains(query) ||
                p.Barcode?.ToLower().Contains(query) == true);
        }

        return filtered.OrderBy(p => p.Category).ThenBy(p => p.Brand).ThenBy(p => p.Name).ToList();
    }

    protected void FilterByCategory(int? categoryId)
    {
        SelectedCategoryId = categoryId;
    }

    protected void OpenAddProduct()
    {
        IsNewProduct = true;
        FormErrorMessage = null;
        DataToUpsert = new ProductsUpsertInput
        {
            Id = 0,
            Name = "",
            Brand = "",
            Category = CategoryDropDowns?.Keys.FirstOrDefault() ?? 1,
            ContainerType = ContainerTypeDropDowns?.Keys.FirstOrDefault() ?? 0,
            SizeDescription = "750ml",
            UnitCost = 0,
            UnitPrice = 0,
            ServingsPerUnit = null,
            Barcode = null,
            Sku = null,
            IsActive = true,
            SortOrder = 0
        };
        ShowProductModal = true;
    }

    protected void EditProduct(ProductsQueryResult product)
    {
        IsNewProduct = false;
        FormErrorMessage = null;

        // Load fresh data by ID
        var output = DbService.ProductsById(new ProductsByIdInput { Id = product.Id });
        if (output.ReturnValue == ProductsByIdOutput.Returns.Ok && output.ResultData != null)
        {
            var p = output.ResultData;
            DataToUpsert = new ProductsUpsertInput
            {
                Id = p.Id,
                Name = p.Name,
                Brand = p.Brand,
                Category = p.Category,
                ContainerType = p.ContainerType,
                SizeDescription = p.SizeDescription,
                UnitCost = p.UnitCost,
                UnitPrice = p.UnitPrice,
                ServingsPerUnit = p.ServingsPerUnit,
                Barcode = p.Barcode,
                Sku = p.Sku,
                IsActive = p.IsActive,
                SortOrder = p.SortOrder
            };
            ShowProductModal = true;
        }
    }

    protected void CloseModal()
    {
        ShowProductModal = false;
        DataToUpsert = null;
        FormErrorMessage = null;
    }

    protected void SaveProduct()
    {
        if (DataToUpsert == null) return;

        if (string.IsNullOrWhiteSpace(DataToUpsert.Brand) && string.IsNullOrWhiteSpace(DataToUpsert.Name))
        {
            FormErrorMessage = "Brand or Name is required.";
            return;
        }

        if (!DataToUpsert.IsValid())
        {
            FormErrorMessage = string.Join(" ", DataToUpsert.ValidationResults.Select(item => item));
            return;
        }

        var output = DbService.ProductsUpsert(DataToUpsert);
        if (output.ReturnValue == ProductsUpsertOutput.Returns.Ok)
        {
            LoadData();
            CloseModal();
        }
        else
        {
            FormErrorMessage = output.ReturnValue switch
            {
                ProductsUpsertOutput.Returns.InsertError => "Error inserting product.",
                ProductsUpsertOutput.Returns.UpdateError => "Error updating product.",
                _ => "Unknown error occurred."
            };
        }
    }

    protected void DeleteProduct()
    {
        if (DataToUpsert?.Id == null || DataToUpsert.Id == 0) return;

        var deleteInput = new ProductsDeleteInput { Id = DataToUpsert.Id.Value };
        var output = DbService.ProductsDelete(deleteInput);

        if (output.ReturnValue == ProductsDeleteOutput.Returns.Ok)
        {
            ShowDeleteConfirm = false;
            LoadData();
            CloseModal();
        }
        else
        {
            ShowDeleteConfirm = false;
            FormErrorMessage = "Error deleting product.";
        }
    }

    // Helper methods for display
    protected string GetCategoryName(int categoryId)
    {
        if (CategoryDropDowns != null && CategoryDropDowns.TryGetValue(categoryId, out var name))
            return name;
        return "Unknown";
    }

    protected string GetCategoryIcon(int categoryId)
    {
        var name = GetCategoryName(categoryId).ToLower();
        return name switch
        {
            "spirits" => "ü•É",
            "wine" => "üç∑",
            "beer" => "üç∫",
            "mixers" => "üßÉ",
            "other" => "üì¶",
            _ => "üì¶"
        };
    }

    protected string GetCategoryBadgeClass(int categoryId)
    {
        var name = GetCategoryName(categoryId).ToLower();
        return name switch
        {
            "spirits" => "badge-liquor",
            "wine" => "badge-wine",
            "beer" => "badge-beer-bottle",
            "mixers" => "badge-mixer",
            _ => ""
        };
    }
}
