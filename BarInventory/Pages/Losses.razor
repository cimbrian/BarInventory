@page "/losses"
@inject BarInventory.BarDB.Service DbService

<PageTitle>Loss Tracking - Bar Inventory</PageTitle>

<div class="page-header">
    <h1 class="page-title">Loss Tracking</h1>
    <p class="page-subtitle">Record breakage, spillage, comps, and returns</p>
</div>

@if (_currentSession == null)
{
    <div class="alert alert-info mb-lg">
        <strong>üìã No active inventory session.</strong> A session will be auto-created when you record a loss.
    </div>
}

@* Summary Stats *@
<div class="stats-grid mb-lg">
    <StatCard Label="Total Losses" Value="@_totalLossValue.ToString("C0")" ValueClass="@(_totalLossValue > 0 ? "warning" : "")" />
    <StatCard Label="Breakage" Value="@GetLossTypeValue(2).ToString("C0")" />
    <StatCard Label="Comps" Value="@GetLossTypeValue(4).ToString("C0")" />
    <StatCard Label="Spillage" Value="@GetLossTypeValue(1).ToString("C0")" />
</div>

@* Add New Loss *@
<div class="card mb-lg">
    <div class="card-header">
        <h3 class="card-title">‚ûï Record a Loss</h3>
    </div>
    <div class="card-body">
        @* Loss Type Selection *@
        <div class="form-group">
            <label class="form-label">Loss Type</label>
            <div class="loss-type-grid">
                @foreach (var lossType in _lossTypes)
                {
                    <button type="button" 
                            class='loss-type-btn @(_selectedLossTypeId == lossType.Id ? "selected" : "")'
                            @onclick="() => _selectedLossTypeId = lossType.Id">
                        <span class="loss-type-icon">@GetLossTypeIcon(lossType.Name)</span>
                        @lossType.Name
                    </button>
                }
            </div>
        </div>
        
        @* Product Selection *@
        <div class="form-group">
            <label class="form-label">Product</label>
            <div class="search-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" 
                       class="form-control" 
                       placeholder="Search products..."
                       @bind="_productSearch"
                       @bind:event="oninput"
                       @onfocus="() => _showProductDropdown = true" />
            </div>
            
            @if (_showProductDropdown && GetFilteredProducts().Any())
            {
                <div class="dropdown-list">
                    @foreach (var product in GetFilteredProducts().Take(10))
                    {
                        <div class='dropdown-item @(_selectedProduct?.Id == product.Id ? "selected" : "")'
                             @onclick="() => SelectProduct(product)">
                            <div class="d-flex align-center gap-sm">
                                <span>@GetCategoryIcon(product.Category)</span>
                                <div>
                                    <div style="font-weight: 500;">@product.Brand @product.Name</div>
                                    <div class="text-muted" style="font-size: 0.85rem;">@product.SizeDescription ‚Ä¢ $@product.UnitCost.ToString("0.00")</div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            
            @if (_selectedProduct != null)
            {
                <div class="alert alert-info mt-sm" style="padding: 0.75rem;">
                    <strong>@_selectedProduct.Brand @_selectedProduct.Name</strong>
                    <span class="text-muted"> - @_selectedProduct.SizeDescription</span>
                </div>
            }
        </div>
        
        @* Quantity and Reason *@
        <div class="d-flex gap-md" style="flex-wrap: wrap;">
            <div class="form-group" style="flex: 1; min-width: 150px;">
                <label class="form-label">Quantity</label>
                <input type="number" 
                       class="form-control" 
                       min="0.1" 
                       step="0.1"
                       @bind="_newLossQuantity" />
            </div>
            
            <div class="form-group" style="flex: 2; min-width: 200px;">
                <label class="form-label">Reason / Notes</label>
                <input type="text" 
                       class="form-control" 
                       placeholder="What happened?"
                       @bind="_newLossReason" />
            </div>
        </div>
        
        @* Estimated Value *@
        @if (_selectedProduct != null && _newLossQuantity > 0)
        {
            <div class="alert alert-warning mb-md">
                Estimated Loss Value: <strong>@((_newLossQuantity * _selectedProduct.UnitCost).ToString("C2"))</strong>
            </div>
        }
        
        <button class="btn btn-danger btn-lg btn-block" 
                @onclick="AddLoss"
                disabled="@(_selectedProduct == null || _newLossQuantity <= 0 || _selectedLossTypeId == 0)">
            üìâ Record Loss
        </button>
    </div>
</div>

@* Loss History *@
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Loss History</h3>
        <span class="text-muted">@_losses.Count records</span>
    </div>
    
    @if (_losses.Any())
    {
        <div class="card-body" style="padding: 0;">
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;"></th>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Product</th>
                            <th class="number">Qty</th>
                            <th class="number">Value</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var loss in _losses)
                        {
                            var product = _productCache.GetValueOrDefault(loss.ProductId);
                            var lossType = _lossTypes.FirstOrDefault(t => t.Id == loss.LossType);
                            <tr>
                                <td>
                                    <button class="btn btn-ghost btn-sm" @onclick="() => DeleteLoss(loss.Id)" title="Delete">
                                        üóëÔ∏è
                                    </button>
                                </td>
                                <td style="white-space: nowrap;">@loss.OccurredAt.ToString("M/d h:mm tt")</td>
                                <td>
                                    <span title="@(lossType?.Name ?? "Unknown")">@GetLossTypeIcon(lossType?.Name ?? "")</span>
                                    @(lossType?.Name ?? "Unknown")
                                </td>
                                <td>@product?.Brand @product?.Name</td>
                                <td class="number">@loss.Quantity.ToString("0.0")</td>
                                <td class="number text-danger">@loss.EstimatedValue.ToString("C2")</td>
                                <td class="text-muted">@(loss.Reason ?? "‚Äî")</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr style="background: var(--bg-tertiary); font-weight: 600;">
                            <td></td>
                            <td colspan="3">Total</td>
                            <td class="number">@_losses.Sum(l => l.Quantity).ToString("0.0")</td>
                            <td class="number text-danger">@_losses.Sum(l => l.EstimatedValue).ToString("C2")</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    }
    else
    {
        <div class="card-body">
            <div class="empty-state">
                <div class="empty-state-icon">‚ú®</div>
                <h2 class="empty-state-title">No Losses Recorded</h2>
                <p class="empty-state-text">Great job! No breakage, spillage, or comps recorded yet.</p>
            </div>
        </div>
    }
</div>

<style>
    .loss-type-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.5rem;
    }
    
    .loss-type-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        padding: 0.75rem 0.5rem;
        border: 2px solid var(--border-primary);
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.15s ease;
        font-size: 0.85rem;
    }
    
    .loss-type-btn:hover {
        border-color: var(--accent-blue);
    }
    
    .loss-type-btn.selected {
        background: var(--accent-blue);
        border-color: var(--accent-blue);
        color: white;
    }
    
    .loss-type-icon {
        font-size: 1.5rem;
    }
    
    .dropdown-list {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-md);
        margin-top: 0.25rem;
        max-height: 250px;
        overflow-y: auto;
    }
    
    .dropdown-item {
        padding: 0.75rem;
        cursor: pointer;
        border-bottom: 1px solid var(--border-primary);
    }
    
    .dropdown-item:hover {
        background: var(--bg-card);
    }
    
    .dropdown-item.selected {
        background: rgba(99, 102, 241, 0.2);
    }
    
    .dropdown-item:last-child {
        border-bottom: none;
    }
</style>

@code {
    private InventorySessionsQueryResult? _currentSession;
    private List<ProductsQueryResult> _products = new();
    private List<LossRecordsQueryResult> _losses = new();
    private List<LossTypesQueryResult> _lossTypes = new();
    private Dictionary<int, ProductsQueryResult> _productCache = new();
    private Dictionary<int, string> _categoryNames = new();
    
    // Form state
    private int _selectedLossTypeId = 0;
    private ProductsQueryResult? _selectedProduct;
    private string _productSearch = "";
    private bool _showProductDropdown = false;
    private decimal _newLossQuantity = 1;
    private string _newLossReason = "";
    
    private decimal _totalLossValue = 0;
    private Dictionary<int, decimal> _lossByType = new();
    
    protected override void OnInitialized()
    {
        BuildDropDowns();
        LoadData();
    }
    
    private void BuildDropDowns()
    {
        // Load loss types
        var lossTypesOutput = DbService.LossTypesQuery(new LossTypesQueryInput());
        if (lossTypesOutput.ReturnValue == LossTypesQueryOutput.Returns.Ok)
        {
            _lossTypes = lossTypesOutput.ResultData.Where(t => t.IsActive).OrderBy(t => t.SortOrder).ToList();
        }
        
        // Load category names
        var catOutput = DbService.ProductCategoriesQuery(new ProductCategoriesQueryInput());
        if (catOutput.ReturnValue == ProductCategoriesQueryOutput.Returns.Ok)
        {
            foreach (var cat in catOutput.ResultData)
            {
                _categoryNames[cat.Id] = cat.Name;
            }
        }
    }
    
    private void LoadData()
    {
        // Load products
        var productsOutput = DbService.ProductsQuery(new ProductsQueryInput());
        if (productsOutput.ReturnValue == ProductsQueryOutput.Returns.Ok)
        {
            _products = productsOutput.ResultData.Where(p => p.IsActive).ToList();
            _productCache = _products.ToDictionary(p => p.Id);
        }
        
        // Get current active session
        var sessionsOutput = DbService.InventorySessionsQuery(new InventorySessionsQueryInput());
        if (sessionsOutput.ReturnValue == InventorySessionsQueryOutput.Returns.Ok)
        {
            _currentSession = sessionsOutput.ResultData.FirstOrDefault(s => !s.IsComplete);
        }
        
        // Load losses
        var lossesOutput = DbService.LossRecordsQuery(new LossRecordsQueryInput());
        if (lossesOutput.ReturnValue == LossRecordsQueryOutput.Returns.Ok)
        {
            if (_currentSession != null)
            {
                _losses = lossesOutput.ResultData
                    .Where(l => l.SessionId == _currentSession.Id)
                    .OrderByDescending(l => l.OccurredAt)
                    .ToList();
            }
            else
            {
                _losses = lossesOutput.ResultData.OrderByDescending(l => l.OccurredAt).Take(20).ToList();
            }
            
            _totalLossValue = _losses.Sum(l => l.EstimatedValue);
            
            // Calculate by type
            _lossByType = _losses
                .GroupBy(l => l.LossType)
                .ToDictionary(g => g.Key, g => g.Sum(l => l.EstimatedValue));
        }
    }
    
    private List<ProductsQueryResult> GetFilteredProducts()
    {
        if (string.IsNullOrWhiteSpace(_productSearch))
            return _products.Take(10).ToList();
        
        var query = _productSearch.ToLower();
        return _products
            .Where(p => p.Name?.ToLower().Contains(query) == true || 
                        p.Brand?.ToLower().Contains(query) == true)
            .Take(10)
            .ToList();
    }
    
    private void SelectProduct(ProductsQueryResult product)
    {
        _selectedProduct = product;
        _productSearch = $"{product.Brand} {product.Name}";
        _showProductDropdown = false;
    }
    
    private void AddLoss()
    {
        if (_selectedProduct == null || _newLossQuantity <= 0 || _selectedLossTypeId == 0)
            return;
        
        // Auto-create session if none exists
        if (_currentSession == null)
        {
            var sessionInput = new InventorySessionsUpsertInput
            {
                SessionName = $"Week {DateTime.Now.DayOfYear / 7 + 1} - {DateTime.Now:MMMM yyyy}",
                SessionDate = DateTime.Now,
                Frequency = 2, // Weekly
                CountedBy = "Auto-created",
                IsComplete = false
            };
            
            var sessionOutput = DbService.InventorySessionsUpsert(sessionInput);
            if (sessionOutput.ReturnValue == InventorySessionsUpsertOutput.Returns.Ok)
            {
                // Reload to get the new session
                var sessionsOutput = DbService.InventorySessionsQuery(new InventorySessionsQueryInput());
                if (sessionsOutput.ReturnValue == InventorySessionsQueryOutput.Returns.Ok)
                {
                    _currentSession = sessionsOutput.ResultData.FirstOrDefault(s => !s.IsComplete);
                }
            }
        }
        
        if (_currentSession == null) return;
        
        var lossInput = new LossRecordsUpsertInput
        {
            SessionId = _currentSession.Id,
            ProductId = _selectedProduct.Id,
            LossType = _selectedLossTypeId,
            Quantity = _newLossQuantity,
            EstimatedValue = _newLossQuantity * _selectedProduct.UnitCost,
            Reason = string.IsNullOrWhiteSpace(_newLossReason) ? null : _newLossReason,
            RecordedBy = "User",
            OccurredAt = DateTime.Now
        };
        
        var output = DbService.LossRecordsUpsert(lossInput);
        if (output.ReturnValue == LossRecordsUpsertOutput.Returns.Ok)
        {
            // Reset form
            _selectedLossTypeId = 0;
            _selectedProduct = null;
            _productSearch = "";
            _newLossQuantity = 1;
            _newLossReason = "";
            
            LoadData();
        }
    }
    
    private void DeleteLoss(int id)
    {
        var output = DbService.LossRecordsDelete(new LossRecordsDeleteInput { Id = id });
        if (output.ReturnValue == LossRecordsDeleteOutput.Returns.Ok)
        {
            LoadData();
        }
    }
    
    private decimal GetLossTypeValue(int typeId)
    {
        return _lossByType.GetValueOrDefault(typeId, 0);
    }
    
    private string GetLossTypeIcon(string typeName)
    {
        var name = typeName.ToLower();
        return name switch
        {
            var n when n.Contains("break") => "üíî",
            var n when n.Contains("spoil") || n.Contains("waste") => "üóëÔ∏è",
            var n when n.Contains("spill") => "üíß",
            var n when n.Contains("comp") => "üéÅ",
            var n when n.Contains("return") => "‚Ü©Ô∏è",
            var n when n.Contains("error") => "‚ùå",
            var n when n.Contains("over") => "üç∏",
            var n when n.Contains("theft") => "üö®",
            var n when n.Contains("train") => "üìö",
            var n when n.Contains("sampl") => "ü•Ç",
            _ => "üìã"
        };
    }
    
    private string GetCategoryIcon(int category)
    {
        var name = _categoryNames.GetValueOrDefault(category, "").ToLower();
        return name switch
        {
            var n when n.Contains("spirit") || n.Contains("liquor") => "ü•É",
            var n when n.Contains("wine") => "üç∑",
            var n when n.Contains("beer") => "üç∫",
            var n when n.Contains("mixer") => "üßÉ",
            _ => "üì¶"
        };
    }
}
