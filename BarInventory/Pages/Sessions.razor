@page "/sessions"
@using BarInventory.BarDB.Models

<PageTitle>Sessions - Bar Inventory</PageTitle>

<div class="page-header d-flex justify-between align-center" style="flex-wrap: wrap; gap: 1rem;">
    <div>
        <h1 class="page-title">Inventory Sessions</h1>
        <p class="page-subtitle">@(SessionList?.Count ?? 0) sessions</p>
    </div>
    <button class="btn btn-primary" @onclick="OpenAddSession">
        ‚ûï New Session
    </button>
</div>

@* Filter Tabs *@
<div class="category-pills mb-md">
    <button class='category-pill @(ShowCompleted == null ? "active" : "")' @onclick="() => ShowCompleted = null">
        All (@(SessionList?.Count ?? 0))
    </button>
    <button class='category-pill @(ShowCompleted == false ? "active" : "")' @onclick="() => ShowCompleted = false">
        üîÑ Active (@(SessionList?.Count(s => !s.IsComplete) ?? 0))
    </button>
    <button class='category-pill @(ShowCompleted == true ? "active" : "")' @onclick="() => ShowCompleted = true">
        ‚úÖ Completed (@(SessionList?.Count(s => s.IsComplete) ?? 0))
    </button>
</div>

@* Sessions Table *@
<div class="card">
    <div class="card-body" style="padding: 0;">
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 80px;"></th>
                        <th>Session</th>
                        <th>Date</th>
                        <th>Frequency</th>
                        <th>Counted By</th>
                        <th>Status</th>
                        <th class="number">Items</th>
                        <th class="number">Losses</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var session in GetFilteredSessions())
                    {
                        var itemCount = GetSessionItemCount(session.Id);
                        var lossCount = GetSessionLossCount(session.Id);
                        <tr class="clickable-row" @onclick="() => OpenSessionSummary(session)">
                            <td @onclick:stopPropagation="true">
                                <button class="btn btn-ghost btn-sm" @onclick="() => EditSession(session)" title="Edit">‚úèÔ∏è</button>
                                <button class="btn btn-ghost btn-sm" @onclick="() => OpenSessionSummary(session)" title="View Summary">üìä</button>
                                @if (!session.IsComplete)
                                {
                                    <button class="btn btn-ghost btn-sm" @onclick="() => ConfirmCompleteSession(session)" title="Complete Session">‚úÖ</button>
                                }
                            </td>
                            <td>
                                <div style="font-weight: 500;">@session.SessionName</div>
                                @if (!string.IsNullOrEmpty(session.Notes))
                                {
                                    <div class="text-muted" style="font-size: 0.8rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@session.Notes</div>
                                }
                            </td>
                            <td>@session.SessionDate.ToString("MMM dd, yyyy")</td>
                            <td>@GetFrequencyName(session.Frequency)</td>
                            <td>@(string.IsNullOrEmpty(session.CountedBy) ? "-" : session.CountedBy)</td>
                            <td>
                                @if (session.IsComplete)
                                {
                                    <span class="item-badge badge-success">‚úÖ Complete</span>
                                    @if (session.CompletedAt.HasValue)
                                    {
                                        <div class="text-muted" style="font-size: 0.75rem;">@session.CompletedAt.Value.ToString("MMM dd, h:mm tt")</div>
                                    }
                                }
                                else
                                {
                                    <span class="item-badge badge-warning">üîÑ In Progress</span>
                                }
                            </td>
                            <td class="number">@itemCount</td>
                            <td class="number">@(lossCount > 0 ? lossCount.ToString() : "-")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@if (!GetFilteredSessions().Any())
{
    <div class="empty-state mt-lg">
        <div class="empty-state-icon">üìã</div>
        <h2 class="empty-state-title">No Sessions Found</h2>
        <p class="empty-state-text">@FilterMessage</p>
    </div>
}

@* Add/Edit Session Modal *@
@if (ShowSessionModal)
{
    <div class="modal-backdrop" @onclick="CloseModal">
        <div class="modal" @onclick:stopPropagation="true" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">@(IsNewSession ? "New Session" : "Edit Session")</h3>
                <button class="modal-close" @onclick="CloseModal">√ó</button>
            </div>
            <div class="modal-body">
                @if (!string.IsNullOrEmpty(FormErrorMessage))
                {
                    <div class="alert alert-danger mb-md">@FormErrorMessage</div>
                }
                
                <div class="form-group">
                    <label class="form-label">Session Name</label>
                    <input type="text" class="form-control" @bind="DataToUpsert!.SessionName" placeholder="e.g., Week 52 - December 2025" />
                </div>
                
                <div class="d-flex gap-md" style="flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label class="form-label">Session Date</label>
                        <input type="date" class="form-control" @bind="DataToUpsert!.SessionDate" />
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label class="form-label">Frequency</label>
                        <select class="form-control" @bind="DataToUpsert!.Frequency">
                            @if (FrequencyDropDowns != null)
                            {
                                @foreach (var freq in FrequencyDropDowns)
                                {
                                    <option value="@freq.Key">@freq.Value</option>
                                }
                            }
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Counted By</label>
                    <input type="text" class="form-control" @bind="DataToUpsert!.CountedBy" placeholder="Name of person counting" />
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notes (Optional)</label>
                    <textarea class="form-control" rows="3" @bind="DataToUpsert!.Notes" placeholder="Any notes about this session..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" @bind="DataToUpsert!.IsComplete" /> Mark as Complete
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                @if (!IsNewSession)
                {
                    <button class="btn btn-danger" style="margin-right: auto;" @onclick="() => ShowDeleteConfirm = true">üóëÔ∏è Delete</button>
                }
                <button class="btn btn-outline" @onclick="CloseModal">Cancel</button>
                <button class="btn btn-primary" @onclick="SaveSession">
                    @(IsNewSession ? "Create Session" : "Save Changes")
                </button>
            </div>
        </div>
    </div>
}

@* Delete Confirmation Modal *@
@if (ShowDeleteConfirm)
{
    <div class="modal-backdrop" @onclick="() => ShowDeleteConfirm = false">
        <div class="modal" @onclick:stopPropagation="true" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">‚ö†Ô∏è Confirm Delete</h3>
                <button class="modal-close" @onclick="() => ShowDeleteConfirm = false">√ó</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong>@DataToUpsert?.SessionName</strong>?</p>
                <p class="text-muted" style="font-size: 0.875rem;">This will also delete all inventory items and counts for this session. This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" @onclick="() => ShowDeleteConfirm = false">Cancel</button>
                <button class="btn btn-danger" @onclick="DeleteSession">üóëÔ∏è Delete</button>
            </div>
        </div>
    </div>
}

@* Complete Session Confirmation Modal *@
@if (ShowCompleteConfirm && SessionToComplete != null)
{
    <div class="modal-backdrop" @onclick="() => ShowCompleteConfirm = false">
        <div class="modal" @onclick:stopPropagation="true" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title">‚úÖ Complete Session</h3>
                <button class="modal-close" @onclick="() => ShowCompleteConfirm = false">√ó</button>
            </div>
            <div class="modal-body">
                <p>Mark <strong>@SessionToComplete.SessionName</strong> as complete?</p>
                <p class="text-muted" style="font-size: 0.875rem;">
                    This will finalize the session counts. The ending quantities will be used as starting quantities for the next session.
                </p>
                @{
                    var itemCount = GetSessionItemCount(SessionToComplete.Id);
                    var countedCount = GetSessionCountedItemCount(SessionToComplete.Id);
                }
                <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: var(--radius-md); margin-top: 0.75rem;">
                    <div class="d-flex justify-between">
                        <span>Items Counted:</span>
                        <strong>@countedCount / @itemCount</strong>
                    </div>
                    @if (countedCount < itemCount)
                    {
                        <div class="text-muted" style="font-size: 0.8rem; margin-top: 0.5rem;">
                            ‚ö†Ô∏è @(itemCount - countedCount) items have not been counted yet
                        </div>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" @onclick="() => ShowCompleteConfirm = false">Cancel</button>
                <button class="btn btn-primary" @onclick="CompleteSession">‚úÖ Complete Session</button>
            </div>
        </div>
    </div>
}

@* Active Session Warning Modal *@
@if (ShowActiveSessionWarning && ActiveSessionWarning != null)
{
    <div class="modal-backdrop" @onclick="() => ShowActiveSessionWarning = false">
        <div class="modal" @onclick:stopPropagation="true" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title">‚ö†Ô∏è Active Session Exists</h3>
                <button class="modal-close" @onclick="() => ShowActiveSessionWarning = false">√ó</button>
            </div>
            <div class="modal-body">
                <p>There is already an active session in progress:</p>
                <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: var(--radius-md); margin: 0.75rem 0;">
                    <div style="font-weight: 600;">@ActiveSessionWarning.SessionName</div>
                    <div class="text-muted" style="font-size: 0.85rem;">Started @ActiveSessionWarning.SessionDate.ToString("MMM dd, yyyy")</div>
                </div>
                <p class="text-muted" style="font-size: 0.875rem;">
                    Please complete or delete the existing session before starting a new one.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" @onclick="() => ShowActiveSessionWarning = false">Close</button>
                <button class="btn btn-primary" @onclick="GoToCapture">üìã Go to Capture</button>
            </div>
        </div>
    </div>
}

@* Session Summary Modal *@
@if (ShowSummaryModal && SelectedSession != null)
{
    <div class="modal-backdrop" @onclick="CloseSummaryModal">
        <div class="modal session-summary-modal" @onclick:stopPropagation="true" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 class="modal-title">üìä @SelectedSession.SessionName</h3>
                <div class="d-flex gap-sm">
                    <a href="/session-report/@SelectedSession.Id" class="btn btn-outline btn-sm" target="_blank" title="Open Printable Report">üñ®Ô∏è Print Report</a>
                    <button class="modal-close" @onclick="CloseSummaryModal">√ó</button>
                </div>
            </div>
            <div class="modal-body" id="session-report">
                @* Session Header Info *@
                <div class="summary-header mb-lg">
                    <div class="summary-meta">
                        <div><strong>Date:</strong> @SelectedSession.SessionDate.ToString("dddd, MMMM dd, yyyy")</div>
                        <div><strong>Counted By:</strong> @(string.IsNullOrEmpty(SelectedSession.CountedBy) ? "N/A" : SelectedSession.CountedBy)</div>
                        <div><strong>Status:</strong> @(SelectedSession.IsComplete ? "‚úÖ Completed" : "üîÑ In Progress")</div>
                        @if (SelectedSession.CompletedAt.HasValue)
                        {
                            <div><strong>Completed:</strong> @SelectedSession.CompletedAt.Value.ToString("MMM dd, yyyy h:mm tt")</div>
                        }
                    </div>
                    @if (!string.IsNullOrEmpty(SelectedSession.Notes))
                    {
                        <div class="summary-notes mt-sm">
                            <strong>Notes:</strong> @SelectedSession.Notes
                        </div>
                    }
                </div>
                
                @* Summary Stats *@
                <div class="stats-grid mb-lg">
                    <StatCard Label="Products Counted" Value="@SummaryItems.Count.ToString()" />
                    <StatCard Label="Total On Hand" Value="@SummaryTotalOnHand.ToString("0.0")" />
                    <StatCard Label="Total Received" Value="@SummaryItems.Sum(i => i.ReceivedQuantity).ToString("0.0")" />
                    <StatCard Label="Received Cost" Value="@SummaryItems.Sum(i => i.ReceivedCost).ToString("C0")" />
                </div>
                
                <div class="stats-grid mb-lg">
                    <StatCard Label="Losses Recorded" Value="@SummaryLosses.Count.ToString()" />
                    <StatCard Label="Total Loss Value" Value="@SummaryLosses.Sum(l => l.EstimatedValue).ToString("C2")" ValueClass="warning" />
                    <StatCard Label="Variance Items" Value="@SummaryVarianceCount.ToString()" ValueClass="@(SummaryVarianceCount > 0 ? "danger" : "")" />
                    <StatCard Label="Inventory Value" Value="@SummaryInventoryValue.ToString("C0")" />
                </div>
                
                @* Inventory Counts by Category *@
                <div class="card mb-lg">
                    <div class="card-header">
                        <h4 class="card-title">üì¶ Inventory Counts</h4>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th class="number">Start</th>
                                    <th class="number">Recv'd</th>
                                    <th class="number">Available</th>
                                    <th class="number">Counted</th>
                                    <th class="number">Variance</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in SummaryItems.OrderBy(i => GetProduct(i.ProductId)?.Category).ThenBy(i => GetProduct(i.ProductId)?.Name))
                                {
                                    var product = GetProduct(item.ProductId);
                                    var counted = GetItemTotalCount(item.Id);
                                    var available = item.StartingQuantity + item.ReceivedQuantity;
                                    var variance = counted - available + item.ComputerSold;
                                    <tr class='@(Math.Abs(variance) > 0.5m ? "variance-row" : "")'>
                                        <td>
                                            <span class="category-icon-sm">@GetCategoryIcon(product?.Category ?? 0)</span>
                                            @product?.Brand @product?.Name
                                            <span class="text-muted">(@product?.SizeDescription)</span>
                                        </td>
                                        <td class="number">@item.StartingQuantity.ToString("0.0")</td>
                                        <td class="number">@item.ReceivedQuantity.ToString("0.0")</td>
                                        <td class="number">@available.ToString("0.0")</td>
                                        <td class="number"><strong>@counted.ToString("0.0")</strong></td>
                                        <td class='number @(variance < -0.5m ? "text-danger" : variance > 0.5m ? "text-success" : "")'>
                                            @(variance > 0 ? "+" : "")@variance.ToString("0.0")
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr style="font-weight: 600; background: var(--bg-tertiary);">
                                    <td>Totals</td>
                                    <td class="number">@SummaryItems.Sum(i => i.StartingQuantity).ToString("0.0")</td>
                                    <td class="number">@SummaryItems.Sum(i => i.ReceivedQuantity).ToString("0.0")</td>
                                    <td class="number">@SummaryItems.Sum(i => i.StartingQuantity + i.ReceivedQuantity).ToString("0.0")</td>
                                    <td class="number">@SummaryTotalOnHand.ToString("0.0")</td>
                                    <td class="number">-</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                @* Losses *@
                @if (SummaryLosses.Any())
                {
                    <div class="card mb-lg">
                        <div class="card-header">
                            <h4 class="card-title">üìâ Losses Recorded</h4>
                        </div>
                        <div class="card-body" style="padding: 0;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Type</th>
                                        <th>Product</th>
                                        <th class="number">Qty</th>
                                        <th class="number">Value</th>
                                        <th>Reason</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var loss in SummaryLosses.OrderByDescending(l => l.OccurredAt))
                                    {
                                        var product = GetProduct(loss.ProductId);
                                        <tr>
                                            <td>@loss.OccurredAt.ToString("M/d h:mm tt")</td>
                                            <td>
                                                <span>@GetLossTypeIcon(loss.LossType)</span>
                                                @GetLossTypeName(loss.LossType)
                                            </td>
                                            <td>@product?.Brand @product?.Name</td>
                                            <td class="number">@loss.Quantity.ToString("0.0")</td>
                                            <td class="number text-danger">@loss.EstimatedValue.ToString("C2")</td>
                                            <td class="text-muted">@(loss.Reason ?? "‚Äî")</td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot>
                                    <tr style="font-weight: 600; background: var(--bg-tertiary);">
                                        <td colspan="3">Total Losses</td>
                                        <td class="number">@SummaryLosses.Sum(l => l.Quantity).ToString("0.0")</td>
                                        <td class="number text-danger">@SummaryLosses.Sum(l => l.EstimatedValue).ToString("C2")</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                }
                
                @* Area Breakdown *@
                @if (SummaryAreaCounts.Any())
                {
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">üìç Counts by Area</h4>
                        </div>
                        <div class="card-body">
                            <div class="area-summary-grid">
                                @foreach (var area in Areas.Where(a => SummaryAreaCounts.Any(c => c.AreaId == a.Id)))
                                {
                                    var areaCounts = SummaryAreaCounts.Where(c => c.AreaId == area.Id).ToList();
                                    var areaTotal = areaCounts.Sum(c => c.FullUnits + (c.HasPartial ? c.PartialAmount / 10m : 0));
                                    <div class="area-summary-card">
                                        <div class="area-summary-name">@area.Name</div>
                                        <div class="area-summary-count">@areaTotal.ToString("0.0")</div>
                                        <div class="area-summary-items">@areaCounts.Count items</div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
                
                @* Report Footer *@
                <div class="report-footer mt-lg text-muted" style="text-align: center; font-size: 0.85rem;">
                    <p>Report generated: @DateTime.Now.ToString("MMMM dd, yyyy h:mm tt")</p>
                    <p>Bar Inventory System</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" @onclick="CloseSummaryModal">Close</button>
                @if (!SelectedSession.IsComplete)
                {
                    <a href="/capture" class="btn btn-primary">Continue Counting ‚Üí</a>
                }
            </div>
        </div>
    </div>
}

<style>
    .clickable-row { cursor: pointer; }
    .clickable-row:hover { background: var(--bg-tertiary); }
    
    .summary-header {
        background: var(--bg-tertiary);
        padding: 1rem;
        border-radius: var(--radius-md);
    }
    
    .summary-meta {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 0.5rem;
    }
    
    .summary-notes {
        padding-top: 0.75rem;
        border-top: 1px solid var(--border-primary);
        font-style: italic;
    }
    
    .variance-row {
        background: rgba(255, 152, 0, 0.1) !important;
    }
    
    .category-icon-sm {
        font-size: 1rem;
        margin-right: 0.25rem;
    }
    
    .area-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
    }
    
    .area-summary-card {
        background: var(--bg-tertiary);
        padding: 1rem;
        border-radius: var(--radius-md);
        text-align: center;
    }
    
    .area-summary-name {
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    
    .area-summary-count {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--accent-blue);
    }
    
    .area-summary-items {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    
    .session-summary-modal {
        width: 95%;
    }
    
    .report-footer {
        border-top: 1px solid var(--border-primary);
        padding-top: 1rem;
    }
    
    @@media print {
        .modal-backdrop {
            position: static;
            background: white;
        }
        .modal {
            position: static;
            max-width: 100%;
            max-height: none;
            box-shadow: none;
            border: none;
        }
        .modal-header button,
        .modal-footer {
            display: none !important;
        }
        .card {
            break-inside: avoid;
        }
        .stats-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }
</style>

@code {
    [Inject] private BarInventory.BarDB.Service DbService { get; set; } = default!;
    [Inject] private NavigationManager NavigationManager { get; set; } = default!;

    // Data Lists
    protected List<InventorySessionsQueryResult>? SessionList { get; set; } = null;
    protected List<InventoryItemsQueryResult> AllItems = new();
    protected List<LossRecordsQueryResult> AllLosses = new();
    protected List<AreaCountsQueryResult> AllAreaCounts = new();
    protected List<InventoryAreasQueryResult> Areas = new();

    // Dropdown Dictionaries
    protected Dictionary<int, string>? FrequencyDropDowns = null;
    protected Dictionary<int, string> LossTypeNames = new();
    protected Dictionary<int, string> CategoryNames = new();
    protected Dictionary<int, ProductsQueryResult> ProductCache = new();

    // Filter State
    protected bool? ShowCompleted = null;
    protected string FilterMessage = "";

    // Modal State
    protected bool ShowSessionModal = false;
    protected bool IsNewSession = true;
    protected string? FormErrorMessage = null;
    protected InventorySessionsUpsertInput? DataToUpsert { get; set; }
    protected bool ShowDeleteConfirm = false;
    
    // Complete Session State
    protected bool ShowCompleteConfirm = false;
    protected InventorySessionsQueryResult? SessionToComplete = null;

    // Active Session Warning State
    protected bool ShowActiveSessionWarning = false;
    protected InventorySessionsQueryResult? ActiveSessionWarning = null;

    // Summary Modal State
    protected bool ShowSummaryModal = false;
    protected InventorySessionsQueryResult? SelectedSession = null;
    protected List<InventoryItemsQueryResult> SummaryItems = new();
    protected List<LossRecordsQueryResult> SummaryLosses = new();
    protected List<AreaCountsQueryResult> SummaryAreaCounts = new();
    protected decimal SummaryTotalOnHand = 0;
    protected decimal SummaryInventoryValue = 0;
    protected int SummaryVarianceCount = 0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            BuildDropDowns();
            LoadData();
            StateHasChanged();
        }
    }

    protected void BuildDropDowns()
    {
        // Frequencies
        if (FrequencyDropDowns == null)
        {
            FrequencyDropDowns = new Dictionary<int, string>();
            var output = DbService.InventoryFrequenciesQuery(new InventoryFrequenciesQueryInput());
            if (output.ReturnValue == InventoryFrequenciesQueryOutput.Returns.Ok && output.ResultData != null)
            {
                foreach (var item in output.ResultData.OrderBy(x => x.SortOrder))
                {
                    FrequencyDropDowns.Add(item.Id, item.Name);
                }
            }
        }
        
        // Loss Types
        var lossOutput = DbService.LossTypesQuery(new LossTypesQueryInput());
        if (lossOutput.ReturnValue == LossTypesQueryOutput.Returns.Ok && lossOutput.ResultData != null)
        {
            foreach (var lt in lossOutput.ResultData)
            {
                LossTypeNames[lt.Id] = lt.Name;
            }
        }
        
        // Categories
        var catOutput = DbService.ProductCategoriesQuery(new ProductCategoriesQueryInput());
        if (catOutput.ReturnValue == ProductCategoriesQueryOutput.Returns.Ok && catOutput.ResultData != null)
        {
            foreach (var c in catOutput.ResultData)
            {
                CategoryNames[c.Id] = c.Name;
            }
        }
        
        // Products
        var prodOutput = DbService.ProductsQuery(new ProductsQueryInput());
        if (prodOutput.ReturnValue == ProductsQueryOutput.Returns.Ok && prodOutput.ResultData != null)
        {
            ProductCache = prodOutput.ResultData.ToDictionary(p => p.Id);
        }
        
        // Areas
        var areasOutput = DbService.InventoryAreasQuery(new InventoryAreasQueryInput());
        if (areasOutput.ReturnValue == InventoryAreasQueryOutput.Returns.Ok && areasOutput.ResultData != null)
        {
            Areas = areasOutput.ResultData.OrderBy(a => a.SortOrder).ToList();
        }
    }

    protected void LoadData()
    {
        var queryOutput = DbService.InventorySessionsQuery(new InventorySessionsQueryInput());
        if (queryOutput.ReturnValue == InventorySessionsQueryOutput.Returns.Ok)
        {
            SessionList = queryOutput.ResultData;
        }
        else
        {
            SessionList = new List<InventorySessionsQueryResult>();
        }
        
        FilterMessage = SessionList?.Count == 0 ? "No sessions found. Create your first session!" : "";
        
        // Load all items and losses for counts
        var itemsOutput = DbService.InventoryItemsQuery(new InventoryItemsQueryInput());
        if (itemsOutput.ReturnValue == InventoryItemsQueryOutput.Returns.Ok)
        {
            AllItems = itemsOutput.ResultData ?? new List<InventoryItemsQueryResult>();
        }
        
        var lossesOutput = DbService.LossRecordsQuery(new LossRecordsQueryInput());
        if (lossesOutput.ReturnValue == LossRecordsQueryOutput.Returns.Ok)
        {
            AllLosses = lossesOutput.ResultData ?? new List<LossRecordsQueryResult>();
        }
        
        var countsOutput = DbService.AreaCountsQuery(new AreaCountsQueryInput());
        if (countsOutput.ReturnValue == AreaCountsQueryOutput.Returns.Ok)
        {
            AllAreaCounts = countsOutput.ResultData ?? new List<AreaCountsQueryResult>();
        }
    }

    protected int GetSessionItemCount(int sessionId) => AllItems.Count(i => i.SessionId == sessionId);
    protected int GetSessionLossCount(int sessionId) => AllLosses.Count(l => l.SessionId == sessionId);

    protected List<InventorySessionsQueryResult> GetFilteredSessions()
    {
        if (SessionList == null) return new List<InventorySessionsQueryResult>();

        var filtered = SessionList.AsEnumerable();

        if (ShowCompleted.HasValue)
            filtered = filtered.Where(s => s.IsComplete == ShowCompleted.Value);

        return filtered.OrderByDescending(s => s.SessionDate).ToList();
    }

    protected void OpenAddSession()
    {
        // Check if there's already an active session
        var activeSession = SessionList?.FirstOrDefault(s => !s.IsComplete);
        if (activeSession != null)
        {
            ActiveSessionWarning = activeSession;
            ShowActiveSessionWarning = true;
            return;
        }
        
        IsNewSession = true;
        FormErrorMessage = null;
        DataToUpsert = new InventorySessionsUpsertInput
        {
            Id = 0,
            SessionName = $"Week {GetWeekNumber(DateTime.Now)} - {DateTime.Now:MMMM yyyy}",
            SessionDate = DateTime.Now,
            CompletedAt = null,
            Frequency = FrequencyDropDowns?.Keys.FirstOrDefault() ?? 1,
            Notes = null,
            IsComplete = false,
            CountedBy = ""
        };
        ShowSessionModal = true;
    }

    protected void GoToCapture()
    {
        ShowActiveSessionWarning = false;
        NavigationManager.NavigateTo("/capture");
    }

    protected int GetWeekNumber(DateTime date)
    {
        return System.Globalization.CultureInfo.CurrentCulture.Calendar.GetWeekOfYear(
            date, 
            System.Globalization.CalendarWeekRule.FirstDay, 
            DayOfWeek.Sunday);
    }

    protected void EditSession(InventorySessionsQueryResult session)
    {
        IsNewSession = false;
        FormErrorMessage = null;

        var output = DbService.InventorySessionsById(new InventorySessionsByIdInput { Id = session.Id });
        if (output.ReturnValue == InventorySessionsByIdOutput.Returns.Ok && output.ResultData != null)
        {
            var s = output.ResultData;
            DataToUpsert = new InventorySessionsUpsertInput
            {
                Id = s.Id,
                SessionName = s.SessionName,
                SessionDate = s.SessionDate,
                CompletedAt = s.CompletedAt,
                Frequency = s.Frequency,
                Notes = s.Notes,
                IsComplete = s.IsComplete,
                CountedBy = s.CountedBy
            };
            ShowSessionModal = true;
        }
    }

    protected void OpenSessionSummary(InventorySessionsQueryResult session)
    {
        SelectedSession = session;
        
        // Load session-specific data
        SummaryItems = AllItems.Where(i => i.SessionId == session.Id).ToList();
        SummaryLosses = AllLosses.Where(l => l.SessionId == session.Id).ToList();
        
        var itemIds = SummaryItems.Select(i => i.Id).ToHashSet();
        SummaryAreaCounts = AllAreaCounts.Where(c => itemIds.Contains(c.InventoryItemId)).ToList();
        
        // Calculate totals
        SummaryTotalOnHand = SummaryAreaCounts.Sum(c => c.FullUnits + (c.HasPartial ? c.PartialAmount / 10m : 0));
        SummaryInventoryValue = SummaryItems.Sum(i => GetItemTotalCount(i.Id) * i.UnitCost);
        
        // Count variances
        SummaryVarianceCount = 0;
        foreach (var item in SummaryItems)
        {
            var counted = GetItemTotalCount(item.Id);
            var available = item.StartingQuantity + item.ReceivedQuantity;
            var variance = counted - available + item.ComputerSold;
            if (Math.Abs(variance) > 0.5m) SummaryVarianceCount++;
        }
        
        ShowSummaryModal = true;
    }

    protected decimal GetItemTotalCount(int itemId)
    {
        return SummaryAreaCounts
            .Where(c => c.InventoryItemId == itemId)
            .Sum(c => c.FullUnits + (c.HasPartial ? c.PartialAmount / 10m : 0));
    }

    protected void CloseSummaryModal()
    {
        ShowSummaryModal = false;
        SelectedSession = null;
    }

    protected void CloseModal()
    {
        ShowSessionModal = false;
        DataToUpsert = null;
        FormErrorMessage = null;
    }

    protected void SaveSession()
    {
        if (DataToUpsert == null) return;

        if (string.IsNullOrWhiteSpace(DataToUpsert.SessionName))
        {
            FormErrorMessage = "Session name is required.";
            return;
        }

        if (DataToUpsert.IsComplete == true && DataToUpsert.CompletedAt == null)
        {
            DataToUpsert.CompletedAt = DateTime.Now;
        }

        if (!DataToUpsert.IsValid())
        {
            FormErrorMessage = string.Join(" ", DataToUpsert.ValidationResults.Select(item => item));
            return;
        }

        var isNew = IsNewSession;
        var output = DbService.InventorySessionsUpsert(DataToUpsert);
        if (output.ReturnValue == InventorySessionsUpsertOutput.Returns.Ok)
        {
            // If this is a NEW session, create inventory items for all active products
            if (isNew && output.Id.HasValue)
            {
                CreateInventoryItemsForSession(output.Id.Value);
            }
            
            LoadData();
            CloseModal();
        }
        else
        {
            FormErrorMessage = "Error saving session.";
        }
    }
    
    protected void CreateInventoryItemsForSession(int sessionId)
    {
        // Get all active products
        var productsOutput = DbService.ProductsQuery(new ProductsQueryInput { IsActive = true });
        if (productsOutput.ReturnValue != ProductsQueryOutput.Returns.Ok || productsOutput.ResultData == null)
            return;
        
        // Get prior session's ending counts to use as starting quantities
        var priorEndingCounts = GetPriorSessionEndingCounts();
        
        // Create an inventory item for each product
        foreach (var product in productsOutput.ResultData)
        {
            // Use prior session's ending count as starting quantity, or 0 if none
            decimal startingQty = priorEndingCounts.GetValueOrDefault(product.Id, 0);
            
            var itemInput = new InventoryItemsUpsertInput
            {
                SessionId = sessionId,
                ProductId = product.Id,
                StartingQuantity = startingQty,
                ReceivedQuantity = 0,
                LastCountedAt = null
            };
            
            if (itemInput.IsValid())
            {
                DbService.InventoryItemsUpsert(itemInput);
            }
        }
    }
    
    protected Dictionary<int, decimal> GetPriorSessionEndingCounts()
    {
        var result = new Dictionary<int, decimal>();
        
        // Find the most recent completed session
        var sessionsOutput = DbService.InventorySessionsQuery(new InventorySessionsQueryInput());
        if (sessionsOutput.ReturnValue != InventorySessionsQueryOutput.Returns.Ok || sessionsOutput.ResultData == null)
            return result;
        
        var priorSession = sessionsOutput.ResultData
            .Where(s => s.IsComplete)
            .OrderByDescending(s => s.SessionDate)
            .FirstOrDefault();
        
        if (priorSession == null)
            return result; // No prior session, all starting quantities will be 0
        
        // Get inventory items from prior session
        var itemsOutput = DbService.InventoryItemsQuery(new InventoryItemsQueryInput());
        if (itemsOutput.ReturnValue != InventoryItemsQueryOutput.Returns.Ok || itemsOutput.ResultData == null)
            return result;
        
        var priorItems = itemsOutput.ResultData.Where(i => i.SessionId == priorSession.Id).ToList();
        
        // Get area counts for prior session items
        var countsOutput = DbService.AreaCountsQuery(new AreaCountsQueryInput());
        if (countsOutput.ReturnValue != AreaCountsQueryOutput.Returns.Ok || countsOutput.ResultData == null)
            return result;
        
        var priorItemIds = priorItems.Select(i => i.Id).ToHashSet();
        var priorCounts = countsOutput.ResultData.Where(c => priorItemIds.Contains(c.InventoryItemId)).ToList();
        
        // Calculate ending quantity for each product (sum of area counts)
        foreach (var item in priorItems)
        {
            var itemCounts = priorCounts.Where(c => c.InventoryItemId == item.Id);
            decimal totalCount = itemCounts.Sum(c => c.FullUnits + (c.HasPartial ? c.PartialAmount / 10m : 0));
            result[item.ProductId] = totalCount;
        }
        
        return result;
    }

    protected void DeleteSession()
    {
        if (DataToUpsert?.Id == null || DataToUpsert.Id == 0) return;

        var deleteInput = new InventorySessionsDeleteInput { Id = DataToUpsert.Id.Value };
        var output = DbService.InventorySessionsDelete(deleteInput);

        if (output.ReturnValue == InventorySessionsDeleteOutput.Returns.Ok)
        {
            ShowDeleteConfirm = false;
            LoadData();
            CloseModal();
        }
        else
        {
            ShowDeleteConfirm = false;
            FormErrorMessage = "Error deleting session. It may have inventory items attached.";
        }
    }

    protected void ConfirmCompleteSession(InventorySessionsQueryResult session)
    {
        SessionToComplete = session;
        ShowCompleteConfirm = true;
    }

    protected void CompleteSession()
    {
        if (SessionToComplete == null) return;

        var input = new InventorySessionsUpsertInput
        {
            Id = SessionToComplete.Id,
            SessionName = SessionToComplete.SessionName,
            SessionDate = SessionToComplete.SessionDate,
            Frequency = SessionToComplete.Frequency,
            CountedBy = SessionToComplete.CountedBy,
            Notes = SessionToComplete.Notes,
            IsComplete = true,
            CompletedAt = DateTime.Now
        };

        if (input.IsValid())
        {
            var output = DbService.InventorySessionsUpsert(input);
            if (output.ReturnValue == InventorySessionsUpsertOutput.Returns.Ok)
            {
                LoadData();
            }
        }

        ShowCompleteConfirm = false;
        SessionToComplete = null;
    }

    protected int GetSessionCountedItemCount(int sessionId)
    {
        if (AllItems == null) return 0;
        var sessionItems = AllItems.Where(i => i.SessionId == sessionId).ToList();
        var sessionItemIds = sessionItems.Select(i => i.Id).ToHashSet();
        
        // Count items that have either: area counts > 0, received quantity > 0, or LastCountedAt set
        int counted = 0;
        foreach (var item in sessionItems)
        {
            bool hasCounts = AllAreaCounts?.Any(ac => ac.InventoryItemId == item.Id && (ac.FullUnits > 0 || ac.PartialAmount > 0)) ?? false;
            bool hasReceived = item.ReceivedQuantity > 0;
            bool wasMarkedCounted = item.LastCountedAt != null;
            
            if (hasCounts || hasReceived || wasMarkedCounted)
                counted++;
        }
        return counted;
    }

    protected string GetFrequencyName(int frequencyId)
    {
        if (FrequencyDropDowns != null && FrequencyDropDowns.TryGetValue(frequencyId, out var name))
            return name;
        return "Unknown";
    }

    protected ProductsQueryResult? GetProduct(int productId) => ProductCache.GetValueOrDefault(productId);

    protected string GetCategoryIcon(int category)
    {
        var name = CategoryNames.GetValueOrDefault(category, "").ToLower();
        return name switch
        {
            var n when n.Contains("spirit") || n.Contains("liquor") => "ü•É",
            var n when n.Contains("wine") => "üç∑",
            var n when n.Contains("beer") => "üç∫",
            var n when n.Contains("mixer") => "üßÉ",
            _ => "üì¶"
        };
    }

    protected string GetLossTypeName(int typeId) => LossTypeNames.GetValueOrDefault(typeId, "Unknown");

    protected string GetLossTypeIcon(int typeId)
    {
        var name = GetLossTypeName(typeId).ToLower();
        return name switch
        {
            var n when n.Contains("break") => "üíî",
            var n when n.Contains("spoil") || n.Contains("waste") => "üóëÔ∏è",
            var n when n.Contains("spill") => "üíß",
            var n when n.Contains("comp") => "üéÅ",
            var n when n.Contains("return") => "‚Ü©Ô∏è",
            var n when n.Contains("error") => "‚ùå",
            var n when n.Contains("theft") => "üö®",
            _ => "üìã"
        };
    }
}
