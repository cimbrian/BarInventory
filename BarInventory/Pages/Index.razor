@page "/"
@using BarInventory.BarDB.Models

<PageTitle>Dashboard - Bar Inventory</PageTitle>

<div class="page-header">
    <h1 class="page-title">Dashboard</h1>
    <p class="page-subtitle">@DateTime.Now.ToString("dddd, MMMM d, yyyy")</p>
</div>

@* Stats Cards *@
<div class="stats-grid mb-lg">
    <div class="stat-card">
        <div class="stat-icon">üì¶</div>
        <div class="stat-content">
            <div class="stat-value">@ProductCount</div>
            <div class="stat-label">Products</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">üìã</div>
        <div class="stat-content">
            <div class="stat-value">@ActiveSessionCount</div>
            <div class="stat-label">Active Sessions</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">üìç</div>
        <div class="stat-content">
            <div class="stat-value">@AreaCount</div>
            <div class="stat-label">Inventory Areas</div>
        </div>
    </div>
    <div class="stat-card stat-card-warning">
        <div class="stat-icon">üìâ</div>
        <div class="stat-content">
            <div class="stat-value">@TotalLossValue.ToString("C0")</div>
            <div class="stat-label">Total Losses (This Month)</div>
        </div>
    </div>
</div>

@* Quick Actions *@
<div class="card mb-lg">
    <div class="card-header">
        <h2 class="card-title">Quick Actions</h2>
    </div>
    <div class="card-body">
        <div class="d-flex gap-md" style="flex-wrap: wrap;">
            <a href="/capture" class="btn btn-primary">
                üì± Start Counting
            </a>
            <a href="/sessions" class="btn btn-outline">
                üìã View Sessions
            </a>
            <a href="/products" class="btn btn-outline">
                üì¶ Manage Products
            </a>
            <a href="/losses" class="btn btn-outline">
                üìâ Record Loss
            </a>
            <a href="/settings" class="btn btn-outline">
                ‚öôÔ∏è Settings
            </a>
            <a href="/training" class="btn btn-ghost">
                üìö Training Guide
            </a>
        </div>
    </div>
</div>

@* Active Session *@
@if (ActiveSession != null)
{
    <div class="card mb-lg">
        <div class="card-header d-flex justify-between align-center">
            <h2 class="card-title">Current Session</h2>
            <span class="item-badge badge-warning">üîÑ In Progress</span>
        </div>
        <div class="card-body">
            <div class="d-flex gap-lg" style="flex-wrap: wrap;">
                <div>
                    <div class="text-muted" style="font-size: 0.85rem;">Session Name</div>
                    <div style="font-weight: 500; font-size: 1.1rem;">@ActiveSession.SessionName</div>
                </div>
                <div>
                    <div class="text-muted" style="font-size: 0.85rem;">Date</div>
                    <div style="font-weight: 500;">@ActiveSession.SessionDate.ToString("MMM dd, yyyy")</div>
                </div>
                <div>
                    <div class="text-muted" style="font-size: 0.85rem;">Counted By</div>
                    <div style="font-weight: 500;">@(string.IsNullOrEmpty(ActiveSession.CountedBy) ? "-" : ActiveSession.CountedBy)</div>
                </div>
            </div>
            <div class="mt-md">
                <a href="/capture" class="btn btn-primary">
                    Continue Counting ‚Üí
                </a>
            </div>
        </div>
    </div>
}

@* Recent Loss Records *@
@if (RecentLosses != null && RecentLosses.Any())
{
    <div class="card">
        <div class="card-header d-flex justify-between align-center">
            <h2 class="card-title">Recent Losses</h2>
            <a href="/losses" class="btn btn-ghost btn-sm">View All ‚Üí</a>
        </div>
        <div class="card-body" style="padding: 0;">
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Product</th>
                            <th>Type</th>
                            <th class="number">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var loss in RecentLosses)
                        {
                            <tr>
                                <td>@loss.OccurredAt.ToString("MMM dd")</td>
                                <td>@GetProductName(loss.ProductId)</td>
                                <td>
                                    <span class="item-badge">@GetLossTypeName(loss.LossType)</span>
                                </td>
                                <td class="number">@loss.EstimatedValue.ToString("C2")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

@code {
    [Inject]
    private BarInventory.BarDB.Service DbService { get; set; } = default!;

    // Dashboard Stats
    protected int ProductCount = 0;
    protected int ActiveSessionCount = 0;
    protected int AreaCount = 0;
    protected decimal TotalLossValue = 0;

    // Active Session
    protected InventorySessionsQueryResult? ActiveSession = null;

    // Recent Losses
    protected List<LossRecordsQueryResult>? RecentLosses = null;

    // Lookup caches
    protected Dictionary<int, string>? ProductDropDowns = null;
    protected Dictionary<int, string>? LossTypeDropDowns = null;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            LoadDashboardData();
            StateHasChanged();
        }
    }

    protected void LoadDashboardData()
    {
        // Count Products
        var productsOutput = DbService.ProductsQuery(new ProductsQueryInput { IsActive = true });
        if (productsOutput.ReturnValue == ProductsQueryOutput.Returns.Ok && productsOutput.ResultData != null)
        {
            ProductCount = productsOutput.ResultData.Count;
            ProductDropDowns = productsOutput.ResultData.ToDictionary(p => p.Id, p => $"{p.Brand} {p.Name}");
        }

        // Count Active Sessions
        var sessionsOutput = DbService.InventorySessionsQuery(new InventorySessionsQueryInput { IsComplete = false });
        if (sessionsOutput.ReturnValue == InventorySessionsQueryOutput.Returns.Ok && sessionsOutput.ResultData != null)
        {
            ActiveSessionCount = sessionsOutput.ResultData.Count;
            ActiveSession = sessionsOutput.ResultData.OrderByDescending(s => s.SessionDate).FirstOrDefault();
        }

        // Count Areas
        var areasOutput = DbService.InventoryAreasQuery(new InventoryAreasQueryInput { IsActive = true });
        if (areasOutput.ReturnValue == InventoryAreasQueryOutput.Returns.Ok && areasOutput.ResultData != null)
        {
            AreaCount = areasOutput.ResultData.Count;
        }

        // Load Loss Types for lookup
        var lossTypesOutput = DbService.LossTypesQuery(new LossTypesQueryInput());
        if (lossTypesOutput.ReturnValue == LossTypesQueryOutput.Returns.Ok && lossTypesOutput.ResultData != null)
        {
            LossTypeDropDowns = lossTypesOutput.ResultData.ToDictionary(l => l.Id, l => l.Name);
        }

        // Load Recent Losses (this month)
        var lossesOutput = DbService.LossRecordsQuery(new LossRecordsQueryInput());
        if (lossesOutput.ReturnValue == LossRecordsQueryOutput.Returns.Ok && lossesOutput.ResultData != null)
        {
            var thisMonth = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
            var monthlyLosses = lossesOutput.ResultData.Where(l => l.OccurredAt >= thisMonth).ToList();
            TotalLossValue = monthlyLosses.Sum(l => l.EstimatedValue);
            RecentLosses = lossesOutput.ResultData.OrderByDescending(l => l.OccurredAt).Take(5).ToList();
        }
    }

    protected string GetProductName(int productId)
    {
        if (ProductDropDowns != null && ProductDropDowns.TryGetValue(productId, out var name))
            return name;
        return "Unknown Product";
    }

    protected string GetLossTypeName(int lossTypeId)
    {
        if (LossTypeDropDowns != null && LossTypeDropDowns.TryGetValue(lossTypeId, out var name))
            return name;
        return "Unknown";
    }
}
