@page "/lookup"
@using BarInventory.BarDB.Models

<PageTitle>Product Lookup - Bar Inventory</PageTitle>

<div class="page-header">
    <h1 class="page-title">Product Lookup</h1>
    <p class="page-subtitle">Search by name, brand, barcode, or SKU</p>
</div>

@* Search Input *@
<div class="card mb-lg">
    <div class="card-body">
        <div class="search-wrapper" style="max-width: 100%;">
            <span class="search-icon">üîç</span>
            <input type="text" 
                   class="form-control" 
                   placeholder="Enter product name, brand, barcode, or SKU..." 
                   @bind="SearchQuery" 
                   @bind:event="oninput"
                   @onkeyup="OnSearchKeyUp"
                   style="font-size: 1.1rem; padding: 1rem 1rem 1rem 3rem;" />
        </div>
        
        @* Quick Filters *@
        <div class="category-pills mt-md">
            <button class='category-pill @(SelectedCategoryId == null ? "active" : "")' @onclick="() => SelectedCategoryId = null">
                All Categories
            </button>
            @if (CategoryDropDowns != null)
            {
                @foreach (var category in CategoryDropDowns)
                {
                    <button class='category-pill @(SelectedCategoryId == category.Key ? "active" : "")' 
                            @onclick="() => SelectedCategoryId = category.Key">
                        @category.Value
                    </button>
                }
            }
        </div>
    </div>
</div>

@* Search Results *@
@if (!string.IsNullOrWhiteSpace(SearchQuery) || SelectedCategoryId.HasValue)
{
    var results = GetSearchResults();
    
    @if (results.Any())
    {
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">@results.Count Result(s)</h2>
            </div>
            <div class="card-body" style="padding: 0;">
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Container</th>
                                <th class="number">Cost</th>
                                <th class="number">Price</th>
                                <th>Barcode/SKU</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var product in results)
                            {
                                <tr @onclick="() => ShowProductDetails(product)" style="cursor: pointer;">
                                    <td>
                                        <div style="font-weight: 500;">@product.Brand @product.Name</div>
                                        <div class="text-muted" style="font-size: 0.8rem;">@product.SizeDescription</div>
                                    </td>
                                    <td>
                                        <span class="item-badge">@GetCategoryName(product.Category)</span>
                                    </td>
                                    <td>@GetContainerName(product.ContainerType)</td>
                                    <td class="number">@product.UnitCost.ToString("C2")</td>
                                    <td class="number">@product.UnitPrice.ToString("C2")</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(product.Barcode))
                                        {
                                            <div style="font-family: monospace; font-size: 0.85rem;">@product.Barcode</div>
                                        }
                                        @if (!string.IsNullOrEmpty(product.Sku))
                                        {
                                            <div class="text-muted" style="font-size: 0.8rem;">SKU: @product.Sku</div>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <h2 class="empty-state-title">No Products Found</h2>
            <p class="empty-state-text">Try a different search term or check your filters.</p>
        </div>
    }
}
else
{
    <div class="empty-state">
        <div class="empty-state-icon">üì±</div>
        <h2 class="empty-state-title">Start Searching</h2>
        <p class="empty-state-text">Enter a product name, brand, barcode, or SKU above.</p>
    </div>
}

@* Product Detail Modal *@
@if (ShowDetailModal && SelectedProduct != null)
{
    <div class="modal-backdrop" @onclick="CloseDetailModal">
        <div class="modal" @onclick:stopPropagation="true" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">@SelectedProduct.Brand @SelectedProduct.Name</h3>
                <button class="modal-close" @onclick="CloseDetailModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Category</div>
                        <div class="detail-value">@GetCategoryName(SelectedProduct.Category)</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Container</div>
                        <div class="detail-value">@GetContainerName(SelectedProduct.ContainerType)</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Size</div>
                        <div class="detail-value">@SelectedProduct.SizeDescription</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Unit Cost</div>
                        <div class="detail-value">@SelectedProduct.UnitCost.ToString("C2")</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Unit Price</div>
                        <div class="detail-value">@SelectedProduct.UnitPrice.ToString("C2")</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Servings/Unit</div>
                        <div class="detail-value">@(SelectedProduct.ServingsPerUnit?.ToString("0") ?? "N/A")</div>
                    </div>
                    @if (!string.IsNullOrEmpty(SelectedProduct.Barcode))
                    {
                        <div class="detail-item" style="grid-column: span 2;">
                            <div class="detail-label">Barcode</div>
                            <div class="detail-value" style="font-family: monospace;">@SelectedProduct.Barcode</div>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(SelectedProduct.Sku))
                    {
                        <div class="detail-item" style="grid-column: span 2;">
                            <div class="detail-label">SKU</div>
                            <div class="detail-value" style="font-family: monospace;">@SelectedProduct.Sku</div>
                        </div>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <a href="/products" class="btn btn-outline">Edit in Products</a>
                <button class="btn btn-primary" @onclick="CloseDetailModal">Close</button>
            </div>
        </div>
    </div>
}

<style>
    .detail-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    .detail-item {
        padding: 0.75rem;
        background: var(--bg-secondary);
        border-radius: 8px;
    }
    .detail-label {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-bottom: 0.25rem;
    }
    .detail-value {
        font-weight: 500;
        font-size: 1rem;
    }
</style>

@code {
    [Inject]
    private BarInventory.BarDB.Service DbService { get; set; } = default!;

    // Data
    protected List<ProductsQueryResult>? ProductList = null;

    // Dropdowns
    protected Dictionary<int, string>? CategoryDropDowns = null;
    protected Dictionary<int, string>? ContainerTypeDropDowns = null;

    // Search State
    protected string SearchQuery = "";
    protected int? SelectedCategoryId = null;

    // Detail Modal
    protected bool ShowDetailModal = false;
    protected ProductsQueryResult? SelectedProduct = null;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            BuildDropDowns();
            LoadProducts();
            StateHasChanged();
        }
    }

    protected void BuildDropDowns()
    {
        // Load Categories
        if (CategoryDropDowns == null)
        {
            CategoryDropDowns = new Dictionary<int, string>();
            var output = DbService.ProductCategoriesQuery(new ProductCategoriesQueryInput());
            if (output.ReturnValue == ProductCategoriesQueryOutput.Returns.Ok && output.ResultData != null)
            {
                foreach (var item in output.ResultData.OrderBy(x => x.SortOrder))
                {
                    CategoryDropDowns.Add(item.Id, item.Name);
                }
            }
        }

        // Load Container Types
        if (ContainerTypeDropDowns == null)
        {
            ContainerTypeDropDowns = new Dictionary<int, string>();
            var output = DbService.ContainerTypesQuery(new ContainerTypesQueryInput());
            if (output.ReturnValue == ContainerTypesQueryOutput.Returns.Ok && output.ResultData != null)
            {
                foreach (var item in output.ResultData.OrderBy(x => x.SortOrder))
                {
                    ContainerTypeDropDowns.Add(item.Id, item.Name);
                }
            }
        }
    }

    protected void LoadProducts()
    {
        var output = DbService.ProductsQuery(new ProductsQueryInput());
        if (output.ReturnValue == ProductsQueryOutput.Returns.Ok)
        {
            ProductList = output.ResultData;
        }
    }

    protected void OnSearchKeyUp(KeyboardEventArgs e)
    {
        // Could add debounce or other behavior here
        StateHasChanged();
    }

    protected List<ProductsQueryResult> GetSearchResults()
    {
        if (ProductList == null) return new List<ProductsQueryResult>();

        var filtered = ProductList.AsEnumerable();

        // Category filter
        if (SelectedCategoryId.HasValue)
            filtered = filtered.Where(p => p.Category == SelectedCategoryId.Value);

        // Search filter
        if (!string.IsNullOrWhiteSpace(SearchQuery))
        {
            var query = SearchQuery.ToLower();
            filtered = filtered.Where(p =>
                p.Name.ToLower().Contains(query) ||
                p.Brand.ToLower().Contains(query) ||
                p.Barcode?.ToLower().Contains(query) == true ||
                p.Sku?.ToLower().Contains(query) == true);
        }

        return filtered.OrderBy(p => p.Brand).ThenBy(p => p.Name).ToList();
    }

    protected void ShowProductDetails(ProductsQueryResult product)
    {
        SelectedProduct = product;
        ShowDetailModal = true;
    }

    protected void CloseDetailModal()
    {
        ShowDetailModal = false;
        SelectedProduct = null;
    }

    protected string GetCategoryName(int categoryId)
    {
        if (CategoryDropDowns != null && CategoryDropDowns.TryGetValue(categoryId, out var name))
            return name;
        return "Unknown";
    }

    protected string GetContainerName(int containerTypeId)
    {
        if (ContainerTypeDropDowns != null && ContainerTypeDropDowns.TryGetValue(containerTypeId, out var name))
            return name;
        return "Unknown";
    }
}
