@inject IJSRuntime JSRuntime

@if (_canInstall)
{
    <div class='install-prompt @(_dismissed ? "dismissed" : "")'>
        <div class="install-content">
            <span class="install-icon">ðŸ“²</span>
            <div class="install-text">
                <strong>Install Bar Inventory</strong>
                <span>Add to your home screen for quick access</span>
            </div>
        </div>
        <div class="install-actions">
            <button class="btn btn-sm btn-outline" @onclick="Dismiss">Later</button>
            <button class="btn btn-sm btn-primary" @onclick="Install">Install</button>
        </div>
    </div>
}

<style>
    .install-prompt {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--bg-card);
        border-top: 1px solid var(--border-primary);
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        z-index: 1000;
        animation: slideUp 0.3s ease;
    }
    
    .install-prompt.dismissed {
        animation: slideDown 0.3s ease forwards;
    }
    
    @@keyframes slideUp {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
    }
    
    @@keyframes slideDown {
        from { transform: translateY(0); }
        to { transform: translateY(100%); }
    }
    
    .install-content {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .install-icon {
        font-size: 1.5rem;
    }
    
    .install-text {
        display: flex;
        flex-direction: column;
        gap: 0.125rem;
    }
    
    .install-text strong {
        color: var(--text-primary);
        font-size: 0.95rem;
    }
    
    .install-text span {
        color: var(--text-secondary);
        font-size: 0.8rem;
    }
    
    .install-actions {
        display: flex;
        gap: 0.5rem;
        flex-shrink: 0;
    }
    
    @@media (max-width: 480px) {
        .install-prompt {
            flex-direction: column;
            text-align: center;
        }
        
        .install-content {
            flex-direction: column;
        }
        
        .install-actions {
            width: 100%;
        }
        
        .install-actions .btn {
            flex: 1;
        }
    }
</style>

@code {
    private bool _canInstall = false;
    private bool _dismissed = false;
    private IJSObjectReference? _module;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _module = await JSRuntime.InvokeAsync<IJSObjectReference>("eval", @"
                    (function() {
                        let deferredPrompt = null;
                        
                        window.addEventListener('beforeinstallprompt', (e) => {
                            e.preventDefault();
                            deferredPrompt = e;
                            DotNet.invokeMethodAsync('BarInventory', 'OnCanInstall');
                        });
                        
                        return {
                            install: async function() {
                                if (deferredPrompt) {
                                    deferredPrompt.prompt();
                                    const { outcome } = await deferredPrompt.userChoice;
                                    deferredPrompt = null;
                                    return outcome === 'accepted';
                                }
                                return false;
                            }
                        };
                    })()
                ");
            }
            catch
            {
                // JS interop not available during prerender
            }
        }
    }

    [JSInvokable]
    public static void OnCanInstall()
    {
        // This would need proper state management for production
        // For now the JS handles the prompt display
    }

    private async Task Install()
    {
        if (_module != null)
        {
            var accepted = await _module.InvokeAsync<bool>("install");
            if (accepted)
            {
                _canInstall = false;
            }
        }
    }

    private async Task Dismiss()
    {
        _dismissed = true;
        await Task.Delay(300);
        _canInstall = false;
    }
}
